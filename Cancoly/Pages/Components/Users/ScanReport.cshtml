@page "/user-scan-report"
@model Cancoly.Pages.Components.Users.ScanReportModel
@{
    Layout = "_MainLayout";
}

<div class="container-xxl flex-grow-1 container-p-y">
    <h4 class="fw-bold py-3 mb-2">
        @Model.Scan.Title Report #@(string.Join("", Model.Id.Take(8)))
        <form method="post" target="_blank">
            <input name="id" hidden value="@Model.Id"/>
            <button type="submit" style="margin-left:60%;" class="btn btn-danger mb-3 text-white">Generate PDF</button>
        </form>
    </h4>


    @if(Model.Status)
    {
        <div class="row">
            <div class="col-12">

                <div class="card mb-4">

                    <h5 class="card-header text-uppercase"><img class="mb-2" style="height:30px;" src="~/logo.png" /></h5>
                    <h5 class="card-header text-uppercase">@Model.Scan.Title</h5>

                    <div class="card-body">
                        <div class="overflow-hidden">
                            <div class="p-0">
                                <div class="row align-items-center">
                                    <div class="col-lg-4 order-lg-1 order-2">
                                        <div class="d-flex align-items-center justify-content-around m-4">
                                            <div class="text-center">
                                                <i class="ti ti-checks fs-3 d-block mb-2"></i>

                                                <h4 class="mb-0 lh-1">@Model.complete</h4>

                                                <p class="mb-0 ">Complete</p>
                                            </div>
                                            <div class="text-center">
                                                <i class="ti ti-forbid-2 fs-3 d-block mb-2"></i>

                                                <h4 class="mb-0 lh-1">@Model.pending</h4>

                                                <p class="mb-0 ">Pending</p>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                                <ul class="nav nav-pills user-profile-tab justify-content-end mt-2 bg-primary-subtle rounded-2 rounded-top-0" id="pills-tab" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link hstack gap-2 rounded-pill py-6 active" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-profile" type="button" role="tab" aria-controls="pills-profile" aria-selected="false" tabindex="-1">
                                            <i class="ti ti-checks fs-5"></i>
                                            <span class="d-none d-md-block">Complete</span>

                                            <span class="badge text-bg-secondary  py-1 px-2 ms-2">@Model.complete</span>

                                        </button>
                                    </li>
                                    @if (Model.complete == 0)
                                    {
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link hstack gap-2 rounded-pill py-6" id="pills-followers-tab" data-bs-toggle="pill" data-bs-target="#pills-followers" type="button" role="tab" aria-controls="pills-followers" aria-selected="false" tabindex="-1">
                                                <i class="ti ti-forbid-2 fs-5"></i>
                                                <span class="d-none d-md-block">Pending</span>

                                                <span class="badge text-bg-secondary py-1 px-2 ms-2">@Model.pending</span>

                                            </button>
                                        </li>
                                    }

                                    <li class="nav-item" role="presentation">
                                        <button class="btn btn-danger hstack gap-2 rounded-pill py-6" type="button">
                                            <i class="ti ti-trash fs-5"></i>
                                            <span class="d-none d-md-block">Delete scan</span>
                                        </button>
                                    </li>
                                    @if (Model.complete > 0)
                                    {
                                        <li class="nav-item" role="presentation">
                                            <a href="@Model.Scan.Report" download class="btn btn-primary hstack gap-2 rounded-0 py-6">
                                                <i class="ti ti-file fs-5"></i>
                                                <span class="d-none d-md-block">Generate report</span>
                                            </a>
                                        </li>
                                    }

                                </ul>
                            </div>
                        </div>
                        <div class="tab-content" id="pills-tabContent">
                            <div class="tab-pane fade active show" id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab" tabindex="0">
                                <div class="row">
                                    <div class="col-lg-4">
                                        <div class="card shadow-none border">
                                            <div class="card-body">
                                                <h4 class="fw-semibold mb-3">Scans</h4>
                                                @if (Model.uploads != null)
                                                {
                                                    <div class="row">
                                                        @foreach (var data in Model.uploads)
                                                        {
                                                            <div class="col-4">
                                                                <a>
                                                                    <img src="@data.ImageUrl" alt="" class="rounded-1 img-fluid mb-9">
                                                                </a>
                                                            </div>
                                                        }

                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-8">
                                        @if (Model.complete == 0)
                                        {
                                            <div class="card shadow-none border-0">
                                                <div class="row justify-content-center">
                                                    <div class="col-md-4 mt-3">
                                                        <div style="height:30vh;width:30vh;" class="spinner-border text-primary" role="status">
                                                            <span class="visually-hidden">Loading...</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                        @if (Model.complete > 0)
                                        {
                                            <div class="card shadow-none border">
                                                <div class="card-body">
                                                    <img src="@Model.current.ImageUrl" height="500" class="rounded-4 mb-3 w-100 object-fit-cover">

                                                    @if (!string.IsNullOrEmpty(Model.current.Label))
                                                    {
                                                        <div class="card-body">
                                                            <div class="vstack gap-3 mt-4">
                                                                <div class="hstack gap-6">
                                                                    <i class="ti ti-hourglass text-dark fs-6"></i>
                                                                    <h6 class=" mb-0">@Model.current.Label</h6>
                                                                </div>
                                                                <div class="hstack gap-6">
                                                                    <i class="ti ti-aspect-ratio text-dark fs-6"></i>
                                                                    <h6 class=" mb-0">@Model.current.Size</h6>
                                                                </div>
                                                                <div class="hstack gap-6">
                                                                    <i class="ti ti-mail text-dark fs-6"></i>
                                                                    <h6 class=" mb-0">@Model.current.Stage</h6>
                                                                </div>

                                                                <div class="hstack gap-6">
                                                                    <i class="ti ti-map-pin text-dark fs-6"></i>
                                                                    <h6 class=" mb-0">@Model.current.Location</h6>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="form-floating mb-3">
                                                            <textarea class="form-control h-140" placeholder="Leave a comment here" id="floatingTextarea2">@Model.current.Report</textarea>
                                                            <label for="floatingTextarea2">Details...</label>
                                                        </div>
                                                        <div class="d-flex align-items-center gap-6 flex-wrap">
                                                            <button class="btn btn-primary ms-auto"> Update </button>
                                                        </div>
                                                    }

                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="pills-followers" role="tabpanel" aria-labelledby="pills-followers-tab" tabindex="0">
                                <div class="d-sm-flex align-items-center justify-content-between mt-3 mb-4">
                                    <h3 class="mb-3 mb-sm-0 fw-semibold d-flex align-items-center">
                                        Pending Scans <span class="badge text-bg-secondary fs-2 rounded-4 py-1 px-2 ms-2">@Model.pending</span>
                                    </h3>
                                </div>
                                <div class="row">
                                    @if (Model.complete > 0)
                                    {
                                        @foreach (var data in Model.uploads)
                                        {
                                            <div class="col-md-6 col-xl-4">
                                                <div class="card">
                                                    <div class="card-body p-4 d-flex align-items-center gap-6 flex-wrap">
                                                        <img src="@data.ImageUrl" class="rounded-circle" width="40" height="40">
                                                        <div>
                                                            @if (Model.complete == Model.uploads.Count())
                                                            {
                                                                <span class="fs-2 d-flex align-items-center badge text-white text-bg-primary">
                                                                    <i class="ti ti-tick text-dark fs-3 me-1"></i> Processing Complete
                                                                </span>
                                                            }
                                                            else
                                                            {
                                                                <span class="fs-2 d-flex align-items-center badge text-white text-bg-warning">
                                                                    <i class="ti ti-tag text-dark fs-3 me-1"></i> Processing on server
                                                                </span>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="col-12">
                                            <div class="alert alert-warning text-center" role="alert">
                                                Processing Complete.
                                            </div>
                                        </div>
                                    }

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="d-flex justify-content-center align-items-center" style="min-height: 300px;">
            <div class="text-center">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div>
                    <strong>Analyzing scan result... please wait</strong>
                </div>
            </div>
        </div>


        
        <script>
            const scanId = '@Model.Scan.Id';

            const checkScanStatus = async () => {
                try {
                    const response = await fetch(`/api/ScanStatus?id=${scanId}`);
                    const result = await response.json();

                    if (result.status === true) {
                        // Refresh the page when scan is complete
                        location.reload();
                    }
                } catch (err) {
                    console.error("Error checking scan status", err);
                }
            };

            // Check every 5 seconds
            setInterval(checkScanStatus, 5000);
        </script>
        
    }
</div>

